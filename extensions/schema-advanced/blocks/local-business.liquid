{% comment %}
  Theme App Block: Schema Advanced — LocalBusiness
  - Emite LocalBusiness/Store/HardwareStore con 25 campos configurables.
  - data-sae="lb" para no ser eliminado por el supresor del Core.
{% endcomment %}

{% liquid
  assign ORG_ID = shop.url | append: "#org"
  assign LB_ID  = shop.url | append: "#local"
  assign public_email = block.settings.lb_email | default: shop.customer_email | default: shop.email

  # LOGO (opcional)
  assign LOGO600  = block.settings.lb_logo | image_url: width: 600  | prepend: "https:" 
  assign LOGO1200 = block.settings.lb_logo | image_url: width: 1200 | prepend: "https:"
%}

{%- comment -%} ===== sameAs (coma o espacio; añade https://; deduplica) ===== {%- endcomment -%}
{%- assign _sameas_raw = block.settings.lb_sameas | default: '' -%}
{%- if _sameas_raw contains ',' -%}
  {%- assign _sameas_parts = _sameas_raw | split: ',' -%}
{%- else -%}
  {%- assign _sameas_parts = _sameas_raw | split: ' ' -%}
{%- endif -%}
{%- assign _sameas_items = '' -%}
{%- assign _same_seen = '|' -%}
{%- assign _same_first = true -%}
{%- for t in _sameas_parts -%}
  {%- assign u = t | strip | remove: '"' | remove: "'" -%}
  {%- if u == '' -%}{%- continue -%}{%- endif -%}
  {%- if u contains '://' -%}{%- assign u_full = u -%}{%- else -%}{%- assign u_full = 'https://' | append: u -%}{%- endif -%}
  {%- assign needle = '|' | append: u_full | append: '|' -%}
  {%- if _same_seen contains needle -%}{%- continue -%}{%- endif -%}
  {%- assign _same_seen = _same_seen | append: u_full | append: '|' -%}
  {%- capture _sameas_items -%}{{ _sameas_items }}{% unless _same_first %},{% endunless %}{{ u_full | json | replace: '\/','/' }}{%- endcapture -%}
  {%- assign _same_first = false -%}
{%- endfor -%}

{%- comment -%} ===== areaServed (códigos país; normaliza alias; deduplica) ===== {%- endcomment -%}
{%- assign _areas_raw = block.settings.lb_area_served | default: '' -%}
{%- assign _areas_up = _areas_raw | upcase | replace: ' ', '' -%}
{%- assign _areas_parts = _areas_up | split: ',' -%}
{%- assign _areas_seen = '|' -%}
{%- assign _areas_items = '' -%}
{%- assign _areas_first = true -%}
{%- for p in _areas_parts -%}
  {%- assign code = p | strip -%}
  {%- if code == '' -%}{%- continue -%}{%- endif -%}
  {%- case code -%}
    {%- when 'UK','EN','ENG','EN-GB' -%}{%- assign code = 'GB' -%}
    {%- when 'EN-US' -%}{%- assign code = 'US' -%}
    {%- when 'ES-ES' -%}{%- assign code = 'ES' -%}
    {%- when 'PT-PT' -%}{%- assign code = 'PT' -%}
    {%- when 'PT-BR' -%}{%- assign code = 'BR' -%}
    {%- when 'EL' -%}{%- assign code = 'GR' -%}
  {%- endcase -%}
  {%- assign k = '|' | append: code | append: '|' -%}
  {%- if _areas_seen contains k -%}{%- continue -%}{%- endif -%}
  {%- assign _areas_seen = _areas_seen | append: code | append: '|' -%}
  {%- capture _areas_items -%}{{ _areas_items }}{% unless _areas_first %},{% endunless %}{{ code | json }}{%- endcapture -%}
  {%- assign _areas_first = false -%}
{%- endfor -%}

{%- comment -%} ===== geo (lat,lng desde texto "lat,lng") ===== {%- endcomment -%}
{%- assign _geo_lat = '' -%}{%- assign _geo_lng = '' -%}
{%- assign _geo_txt = block.settings.lb_geo_coords | default: '' | strip -%}
{%- if _geo_txt contains ',' -%}
  {%- assign _geo_parts = _geo_txt | split: ',' -%}
  {%- assign _geo_lat = _geo_parts[0] | strip -%}
  {%- assign _geo_lng = _geo_parts[1] | strip -%}
{%- endif -%}

{%- comment -%} ===== openingHoursSpecification ===== {%- endcomment -%}
{%- assign _oh_mode = block.settings.lb_opening_mode | default: 'weekly' -%}
{%- assign _oh_json = '' -%}

{%- if _oh_mode == '24_7' -%}
  {%- capture _oh_json -%}
[
  { "@type":"OpeningHoursSpecification",
    "dayOfWeek":["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],
    "opens":"00:00","closes":"23:59"
  }
]
  {%- endcapture -%}

{%- elsif _oh_mode == 'closed' -%}
  {%- assign _oh_json = '' -%}

{%- elsif _oh_mode == 'manual_json' -%}
  {%- assign _manual = block.settings.lb_hours_json | strip -%}
  {%- if _manual != '' -%}{%- assign _oh_json = _manual -%}{%- endif -%}

{%- else -%}{% comment %} weekly {% endcomment %}
  {%- assign _wd_open = block.settings.lb_hours_weekdays_open | default: '09:00' -%}
  {%- assign _wd_close = block.settings.lb_hours_weekdays_close | default: '18:00' -%}
  {%- assign _sa_open = block.settings.lb_hours_sat_open | default: '' -%}
  {%- assign _sa_close = block.settings.lb_hours_sat_close | default: '' -%}
  {%- assign _su_open = block.settings.lb_hours_sun_open | default: '' -%}

  {%- capture _oh -%}
[
  { "@type":"OpeningHoursSpecification",
    "dayOfWeek":["Monday","Tuesday","Wednesday","Thursday","Friday"],
    "opens":"{{ _wd_open }}","closes":"{{ _wd_close }}" }
  {%- if _sa_open != '' and _sa_close != '' -%}
  ,{ "@type":"OpeningHoursSpecification",
    "dayOfWeek":"Saturday",
    "opens":"{{ _sa_open }}","closes":"{{ _sa_close }}" }
  {%- endif -%}
  {%- if _su_open != '' -%}
  ,{ "@type":"OpeningHoursSpecification",
    "dayOfWeek":"Sunday",
    "opens":"{{ _su_open }}","closes":"{{ _su_open | split: ':' | first }}:{{ _su_open | split: ':' | last }}" }
  {%- endif -%}
]
  {%- endcapture -%}
  {%- assign _oh_json = _oh -%}
{%- endif -%}

{%- if block.settings.lb_enable -%}
<script type="application/ld+json" data-sae="lb">
{
  "@context": "https://schema.org",
  "@type": {{ block.settings.lb_type | default: "HardwareStore" | json }},
  "@id": {{ LB_ID | json | replace: '\/','/' }},
  "name": {{ block.settings.lb_name | default: shop.name | json }},
  "url": {{ shop.url | json | replace: '\/','/' }},
  "isPartOf": { "@id": {{ ORG_ID | json | replace: '\/','/' }} }{% if block.settings.lb_logo %}
 , "logo": {{ LOGO600  | json | replace: '\/','/' }}
 , "image": {{ LOGO1200 | json | replace: '\/','/' }}{% endif %}{% if block.settings.lb_price_range %}
 , "priceRange": {{ block.settings.lb_price_range | json }}{% endif %}{% if _sameas_items != '' %}
 , "sameAs": [ {{ _sameas_items }} ]{% endif %}{% if _areas_items != '' %}
 , "areaServed": [ {{ _areas_items }} ]{% endif %}{% if block.settings.lb_payment_methods %}
 , "paymentAccepted": {{ block.settings.lb_payment_methods | strip | replace: '\n', ', ' | replace: '  ', ' ' | json }}{% endif %}{% if block.settings.lb_currencies_accepted %}
 , "currenciesAccepted": {{ block.settings.lb_currencies_accepted | upcase | json }}{% endif %}{% if block.settings.lb_phone %}
 , "telephone": {{ block.settings.lb_phone | json }}{% endif %}{% if public_email %}
 , "email": {{ public_email | json }}{% endif %}
 , "address": {
    "@type":"PostalAddress"{% if block.settings.lb_address_street %},
    "streetAddress": {{ block.settings.lb_address_street | json }}{% endif %}{% if block.settings.lb_address_city %},
    "addressLocality": {{ block.settings.lb_address_city | json }}{% endif %}{% if block.settings.lb_address_region %},
    "addressRegion": {{ block.settings.lb_address_region | json }}{% endif %}{% if block.settings.lb_address_postal %},
    "postalCode": {{ block.settings.lb_address_postal | json }}{% endif %}{% if block.settings.lb_address_country %},
    "addressCountry": {{ block.settings.lb_address_country | upcase | json }}{% endif %}
  }{% if _geo_lat != '' and _geo_lng != '' %}
 , "geo": { "@type":"GeoCoordinates","latitude": {{ _geo_lat }},"longitude": {{ _geo_lng }} }{% endif %}{% if block.settings.lb_maps_url %}
 , "hasMap": {{ block.settings.lb_maps_url | json | replace: '\/','/' }}{% endif %}{% if _oh_json != '' %}
 , "openingHoursSpecification": {{ _oh_json }}{% endif %}
}
</script>
{%- endif -%}

{% schema %}
{
  "name": "SAE LocalBusiness",
  "target": "head",
  "settings": [
    { "type": "checkbox", "id": "lb_enable",
      "label": "t:lb.settings.lb_enable.label",
      "info":  "t:lb.settings.lb_enable.info",
      "default": true
    },
    { "type": "select", "id": "lb_type",
      "label": "t:lb.settings.lb_type.label",
      "options": [
        { "value": "HardwareStore", "label": "HardwareStore" },
        { "value": "Store", "label": "Store" },
        { "value": "LocalBusiness", "label": "LocalBusiness" },
        { "value": "HomeAndConstructionBusiness", "label": "HomeAndConstructionBusiness" }
      ],
      "default": "HardwareStore"
    },
    { "type": "text", "id": "lb_name",
      "label": "t:lb.settings.lb_name.label",
      "info":  "t:lb.settings.lb_name.info"
    },
    { "type": "image_picker", "id": "lb_logo",
      "label": "t:lb.settings.lb_logo.label",
      "info":  "t:lb.settings.lb_logo.info"
    },
    { "type": "textarea", "id": "lb_sameas",
      "label": "t:lb.settings.lb_sameas.label",
      "info":  "t:lb.settings.lb_sameas.info"
    },
    { "type": "text", "id": "lb_phone",
      "label": "t:lb.settings.lb_phone.label"
    },
    { "type": "text", "id": "lb_email",
      "label": "t:lb.settings.lb_email.label"
    },
    { "type": "text", "id": "lb_price_range",
      "label": "t:lb.settings.lb_price_range.label",
      "default": "€€"
    },

    { "type": "text", "id": "lb_address_street",
      "label": "t:lb.settings.lb_address_street.label"
    },
    { "type": "text", "id": "lb_address_city",
      "label": "t:lb.settings.lb_address_city.label"
    },
    { "type": "text", "id": "lb_address_region",
      "label": "t:lb.settings.lb_address_region.label"
    },
    { "type": "text", "id": "lb_address_postal",
      "label": "t:lb.settings.lb_address_postal.label"
    },
    { "type": "text", "id": "lb_address_country",
      "label": "t:lb.settings.lb_address_country.label",
      "default": "ES"
    },

    { "type": "text", "id": "lb_geo_coords",
      "label": "t:lb.settings.lb_geo_coords.label",
      "info":  "t:lb.settings.lb_geo_coords.info"
    },
    { "type": "text", "id": "lb_maps_url",
      "label": "t:lb.settings.lb_maps_url.label",
      "info":  "t:lb.settings.lb_maps_url.info"
    },

    { "type": "text", "id": "lb_area_served",
      "label": "t:lb.settings.lb_area_served.label",
      "info":  "t:lb.settings.lb_area_served.info",
      "default": "ES,PT"
    },
    { "type": "textarea", "id": "lb_payment_methods",
      "label": "t:lb.settings.lb_payment_methods.label",
      "info":  "t:lb.settings.lb_payment_methods.info"
    },
    { "type": "text", "id": "lb_currencies_accepted",
      "label": "t:lb.settings.lb_currencies_accepted.label",
      "default": "EUR"
    },

    { "type": "select", "id": "lb_opening_mode",
      "label": "t:lb.settings.lb_opening_mode.label",
      "options": [
        { "value": "weekly",       "label": "t:lb.settings.lb_opening_mode.options.weekly" },
        { "value": "24_7",         "label": "t:lb.settings.lb_opening_mode.options.24_7" },
        { "value": "closed",       "label": "t:lb.settings.lb_opening_mode.options.closed" },
        { "value": "manual_json",  "label": "t:lb.settings.lb_opening_mode.options.manual_json" }
      ],
      "default": "weekly"
    },
    { "type": "textarea", "id": "lb_hours_json",
      "label": "t:lb.settings.lb_hours_json.label",
      "info":  "t:lb.settings.lb_hours_json.info"
    },
    { "type": "text", "id": "lb_hours_weekdays_open",
      "label": "t:lb.settings.lb_hours_weekdays_open.label",
      "default": "09:00"
    },
    { "type": "text", "id": "lb_hours_weekdays_close",
      "label": "t:lb.settings.lb_hours_weekdays_close.label",
      "default": "18:00"
    },
    { "type": "text", "id": "lb_hours_sat_open",
      "label": "t:lb.settings.lb_hours_sat_open.label",
      "default": "10:00"
    },
    { "type": "text", "id": "lb_hours_sat_close",
      "label": "t:lb.settings.lb_hours_sat_close.label",
      "default": "14:00"
    },
    { "type": "text", "id": "lb_hours_sun_open",
      "label": "t:lb.settings.lb_hours_sun_open.label",
      "info":  "t:lb.settings.lb_hours_sun_open.info"
    }
  ]
}
{% endschema %}
